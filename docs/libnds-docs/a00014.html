<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>libnds: Graphics/Sprites/fire_and_sprites/source/main.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="docs.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>Graphics/Sprites/fire_and_sprites/source/main.cpp</h1><div class="fragment"><pre class="fragment"><span class="comment">/*---------------------------------------------------------------------------------</span>
<span class="comment">    $Id: main.cpp,v 1.16 2008-11-29 22:58:58 wntrmute Exp $</span>
<span class="comment"></span>
<span class="comment">    -- dovoto</span>
<span class="comment"></span>
<span class="comment">---------------------------------------------------------------------------------*/</span>

<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="a00119.html" title="the master include file for nds applications.">nds.h</a>&gt;</span>

<span class="comment">//include our ball pcx file (auto generated)</span>
<span class="preprocessor">#include &quot;ball_pcx.h&quot;</span>

<span class="preprocessor">#define NUM_SPRITES 128 </span>
<span class="preprocessor"></span>
<a name="_a0"></a><a class="code" href="a00083.html" title="A bitfield of sprite attribute goodness...ugly to look at but not so bad to use.">SpriteEntry</a> OAMCopySub[128];

<span class="comment">//simple sprite struct</span>
<span class="keyword">typedef</span> <span class="keyword">struct </span>{
    <span class="keywordtype">int</span> x,y;            <span class="comment">// screen co-ordinates </span>
    <span class="keywordtype">int</span> dx, dy;         <span class="comment">// velocity</span>
    <a class="code" href="a00083.html" title="A bitfield of sprite attribute goodness...ugly to look at but not so bad to use.">SpriteEntry</a>* oam;   <span class="comment">// pointer to the sprite attributes in OAM</span>
    <span class="keywordtype">int</span> gfxID;          <span class="comment">// graphics lovation</span>
}Sprite;


<span class="comment">//---------------------------------------------------------------------------------</span>
<span class="keywordtype">void</span> MoveSprite(Sprite* sp) {
<span class="comment">//---------------------------------------------------------------------------------</span>
    <span class="keywordtype">int</span> x = sp-&gt;x &gt;&gt; 8;
    <span class="keywordtype">int</span> y = sp-&gt;y &gt;&gt; 8;

    sp-&gt;oam-&gt;x = x;
    sp-&gt;oam-&gt;y = y;

} 



<span class="comment">//---------------------------------------------------------------------------------</span>
<span class="keywordtype">void</span> initOAM(<span class="keywordtype">void</span>) {
<span class="comment">//---------------------------------------------------------------------------------</span>
    <span class="keywordtype">int</span> i;

    <span class="keywordflow">for</span>(i = 0; i &lt; 128; i++) {
        OAMCopySub[i].<a name="a1"></a>attribute[0] = ATTR0_DISABLED;
    }   
}

<span class="comment">//---------------------------------------------------------------------------------</span>
<span class="keywordtype">void</span> updateOAM(<span class="keywordtype">void</span>) {
<span class="comment">//---------------------------------------------------------------------------------</span>
    memcpy(<a name="a2"></a><a class="code" href="a00135.html#adf411d6fca761fb6a0139c91e7a057fe" title="pointer to Object Attribute Memory (Sub engine)">OAM_SUB</a>, OAMCopySub, 128 * <span class="keyword">sizeof</span>(<a class="code" href="a00083.html" title="A bitfield of sprite attribute goodness...ugly to look at but not so bad to use.">SpriteEntry</a>));
}



<span class="comment">//---------------------------------------------------------------------------------</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {
<span class="comment">//---------------------------------------------------------------------------------</span>
    
    <a name="a3"></a><a class="code" href="a00121.html#ac2a9e79eb120216f855626495b7bd18a" title="16 bit unsigned integer.">uint16</a>* back = <a name="a4"></a><a class="code" href="a00135.html#a0871eee8d0d2336c97e93d3d5a97e415" title="pointer to vram bank A mapped as LCD">VRAM_A</a>;
    <a class="code" href="a00121.html#ac2a9e79eb120216f855626495b7bd18a" title="16 bit unsigned integer.">uint16</a>* front = <a name="a5"></a><a class="code" href="a00135.html#a00d7e905c9e3c3c29fd2eee42c6b8d86" title="pointer to vram bank B mapped as LCD">VRAM_B</a>;

    Sprite sprites[NUM_SPRITES];

    <span class="keywordtype">int</span> i, delta = 0;
    <span class="keywordtype">int</span> ix = 0;
    <span class="keywordtype">int</span> iy = 0;
    <span class="keywordtype">int</span> screen = 1;
    <a class="code" href="a00121.html#ac2a9e79eb120216f855626495b7bd18a" title="16 bit unsigned integer.">uint16</a>* map0 = (<a class="code" href="a00121.html#ac2a9e79eb120216f855626495b7bd18a" title="16 bit unsigned integer.">uint16</a>*)<a name="a6"></a><a class="code" href="a00139.html#ga399ed5775aff4a2f76bc3ab9a491c2f5" title="A macro which returns a u16* pointer to background Map ram (Sub Engine).">SCREEN_BASE_BLOCK_SUB</a>(1);
    <a class="code" href="a00121.html#ac2a9e79eb120216f855626495b7bd18a" title="16 bit unsigned integer.">uint16</a>* map1 = (<a class="code" href="a00121.html#ac2a9e79eb120216f855626495b7bd18a" title="16 bit unsigned integer.">uint16</a>*)<a class="code" href="a00139.html#ga399ed5775aff4a2f76bc3ab9a491c2f5" title="A macro which returns a u16* pointer to background Map ram (Sub Engine).">SCREEN_BASE_BLOCK_SUB</a>(2);
    <a class="code" href="a00121.html#ac2a9e79eb120216f855626495b7bd18a" title="16 bit unsigned integer.">uint16</a> red;

    <span class="comment">//set main display to render directly from the frame buffer</span>
    <a name="a7"></a><a class="code" href="a00135.html#ae3ea5c2e57cc40d6a88e21c4dcb742c8" title="the main 2D engine video mode">videoSetMode</a>(<a name="a8"></a><a class="code" href="a00135.html#a1e46218ee302fcc8c77e4ea0968ea149a31546318607e0b541f01adc27eb2e138" title="video display directly from VRAM_B in LCD mode">MODE_FB1</a>);
    
    <span class="comment">//set up the sub display</span>
    <a name="a9"></a><a class="code" href="a00135.html#a9512ccda7405589119053638849cc56d" title="the sub 2D engine video mode">videoSetModeSub</a>(<a name="a10"></a><a class="code" href="a00135.html#a1e46218ee302fcc8c77e4ea0968ea149a9cdd63a31b19e5ff101d468d2af31fe6" title="4 2D backgrounds">MODE_0_2D</a> | 
                    DISPLAY_SPR_1D_LAYOUT | 
                    DISPLAY_SPR_ACTIVE | 
                    DISPLAY_BG0_ACTIVE |
                    DISPLAY_BG1_ACTIVE );
    
    <span class="comment">//vram banks are somewhat complex</span>
    <a name="a11"></a><a class="code" href="a00135.html#a06a44d818273b87e2095dab54e62f4c8" title="Set the main 4 bank modes.">vramSetMainBanks</a>(<a name="a12"></a><a class="code" href="a00135.html#a348d2824280b1b94792407f4920e346aa48ee60158f850200439ff2261233d6ad" title="maps vram a to lcd.">VRAM_A_LCD</a>, <a name="a13"></a><a class="code" href="a00135.html#afa2bb9abef2b071547e282f1f4f91929a970994e5ebec5a90409890bd29e648a0" title="maps vram b to lcd.">VRAM_B_LCD</a>, <a name="a14"></a><a class="code" href="a00135.html#a3bce26742d17eb8c77cf7338089f3ccfa7cb3c69e848e7b5f045e932ee1e41f94" title="maps vram c to sub engine background slot 0.">VRAM_C_SUB_BG</a>, <a name="a15"></a><a class="code" href="a00135.html#aec1c55c4879c6c563ac5a814a0bde674a10690b0d1b48341877aa487cf600c578" title="maps vram d to sub engine sprites slot 0.">VRAM_D_SUB_SPRITE</a>); 

    <a name="_a16"></a><a class="code" href="a00080.html" title="A generic image structure.">sImage</a> ball;

    <span class="comment">//load our ball pcx file into an image</span>
    <a name="a17"></a><a class="code" href="a00122.html#a5c59ba324a60280e1e91bdc9a58a5f3d" title="Loads an image structure with data from PCX formatted data.">loadPCX</a>((<a name="a18"></a><a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>*)ball_pcx, &amp;ball);
    
    <span class="comment">//tile it so it is usefull as sprite data</span>
    <a name="a19"></a><a class="code" href="a00107.html#a4884960da99e754685ce0ae73bded711" title="Tiles 8 bit image data into a sequence of 8x8 tiles.">imageTileData</a>(&amp;ball);

    <span class="comment">// Sprite initialisation</span>
    <span class="keywordflow">for</span>(i = 0; i &lt; 256; i++)
        <a name="a20"></a><a class="code" href="a00135.html#abf010915231579ba1bfa697cc73b8d84" title="sprite palette memory (sub engine)">SPRITE_PALETTE_SUB</a>[i] = ball.<a name="a21"></a><a class="code" href="a00080.html#a590541cf94347434a1578aaefab271e3" title="A pointer to the palette data.">palette</a>[i];

    <span class="keywordflow">for</span>(i = 0; i&lt; 32*16; i++)
        <a name="a22"></a><a class="code" href="a00135.html#a3766ba1bd5aebc8d1eb190c169edd548" title="sprite graphics memory (sub engine)">SPRITE_GFX_SUB</a>[i] = ball.<a name="a23"></a><a class="code" href="a00080.html#a48ff0e282b646989a49b49a420e5b01b" title="A union of data pointers to the pixel data.">image</a>.<a name="a24"></a><a class="code" href="a00080.html#a90cd62688183af5cefa9deda50d187a3" title="pointer to 16 bit data.">data16</a>[i];
    
    <span class="comment">//turn off sprites</span>
    initOAM();

    <span class="keywordflow">for</span>(i = 0; i &lt; NUM_SPRITES; i++) {
        <span class="comment">//random place and speed</span>
        sprites[i].x = rand() &amp; 0xFFFF;
        sprites[i].y = rand() &amp; 0x7FFF;
        sprites[i].dx = (rand() &amp; 0xFF) + 0x100;
        sprites[i].dy = (rand() &amp; 0xFF) + 0x100;
    
        <span class="keywordflow">if</span>(rand() &amp; 1)
            sprites[i].dx = -sprites[i].dx;
        <span class="keywordflow">if</span>(rand() &amp; 1)
            sprites[i].dy = -sprites[i].dy;
    
        sprites[i].oam = &amp;OAMCopySub[i];
        sprites[i].gfxID = 0;
    
        <span class="comment">//set up our sprites OAM entry attributes</span>
        sprites[i].oam-&gt;attribute[0] = ATTR0_COLOR_256 | ATTR0_SQUARE;  
        sprites[i].oam-&gt;attribute[1] = ATTR1_SIZE_32;
        sprites[i].oam-&gt;attribute[2] = sprites[i].gfxID;
    }

    <span class="comment">//set up two backgrounds to scroll around</span>
    <a name="a25"></a><a class="code" href="a00139.html#gae65aa7425c2f25f5c5ce1517657dd7d6" title="Background 0 Control register (sub engine) GBATEK Reference">REG_BG0CNT_SUB</a> = <a name="a26"></a><a class="code" href="a00137.html#gga7afc211c644079338a1f032ea5e90460ac93b22bf41e4d24456edd3035d45e2ba" title="256 color text background">BG_COLOR_256</a> | (1 &lt;&lt; <a name="a27"></a><a class="code" href="a00137.html#ga0bd976e6d824e5f3bca758d0daebc27b" title="The shift to apply to map base when storing it in a background control register.">MAP_BASE_SHIFT</a>);
    <a name="a28"></a><a class="code" href="a00139.html#gae2b6b1703de947839df74ac3948816ae" title="Background 1 Control register (sub engine) GBATEK Reference">REG_BG1CNT_SUB</a> = <a class="code" href="a00137.html#gga7afc211c644079338a1f032ea5e90460ac93b22bf41e4d24456edd3035d45e2ba" title="256 color text background">BG_COLOR_256</a> | (2 &lt;&lt; <a class="code" href="a00137.html#ga0bd976e6d824e5f3bca758d0daebc27b" title="The shift to apply to map base when storing it in a background control register.">MAP_BASE_SHIFT</a>);

    <a name="a29"></a><a class="code" href="a00135.html#a5f83d4f33ba2cd0fe614788505151262" title="background palette memory (sub engine)">BG_PALETTE_SUB</a>[0] = <a name="a30"></a><a class="code" href="a00135.html#abd4530c7880d389c9ea70e2e3b84aa9d" title="Macro to convert 5 bit r g b components into a single 15 bit RGB triplet.">RGB15</a>(10,10,10);
    <a class="code" href="a00135.html#a5f83d4f33ba2cd0fe614788505151262" title="background palette memory (sub engine)">BG_PALETTE_SUB</a>[1] = <a class="code" href="a00135.html#abd4530c7880d389c9ea70e2e3b84aa9d" title="Macro to convert 5 bit r g b components into a single 15 bit RGB triplet.">RGB15</a>(0,16,0);
    <a class="code" href="a00135.html#a5f83d4f33ba2cd0fe614788505151262" title="background palette memory (sub engine)">BG_PALETTE_SUB</a>[2] = <a class="code" href="a00135.html#abd4530c7880d389c9ea70e2e3b84aa9d" title="Macro to convert 5 bit r g b components into a single 15 bit RGB triplet.">RGB15</a>(0,0,31);
    
    <span class="comment">//load the maps with alternating tiles (0,1 for bg0 and 0,2 for bg1)</span>
    <span class="keywordflow">for</span>(iy = 0; iy &lt; 32; iy++) {
        <span class="keywordflow">for</span>(ix = 0; ix &lt;32; ix++) {
            map0[iy * 32 + ix] = (ix ^ iy) &amp; 1;
            map1[iy * 32 + ix] = ((ix ^ iy) &amp; 1)&lt;&lt;1;
        }
    }    

    <span class="comment">//fill 2 tiles with different colors</span>
    <span class="keywordflow">for</span>(i = 0; i &lt; 64 / 2; i++) {
        <a name="a31"></a><a class="code" href="a00135.html#ae3a36b13fb02843f645b5e9885d4e2d6" title="background graphics memory (sub engine)">BG_GFX_SUB</a>[i+32] = 0x0101;
        <a class="code" href="a00135.html#ae3a36b13fb02843f645b5e9885d4e2d6" title="background graphics memory (sub engine)">BG_GFX_SUB</a>[i+32+32] = 0x0202;
    }   

    <span class="keywordflow">while</span> (1) {
        <span class="comment">//scroll the background</span>
        <a name="a32"></a><a class="code" href="a00138.html#ga3f4ae1b5b9752ff1111e5a692e90fdcb" title="Background 0 horizontal scroll register (main engine).">REG_BG0HOFS</a> = delta ;
        <a name="a33"></a><a class="code" href="a00138.html#ga963be0941288966259db487c881c4bd7" title="Background 0 vertical scroll register (main engine).">REG_BG0VOFS</a> = delta++ ;
        
        <span class="comment">//move the sprites</span>
        <span class="keywordflow">for</span>(i = 0; i &lt; NUM_SPRITES; i++) {
            sprites[i].x += sprites[i].dx;
            sprites[i].y += sprites[i].dy;
            
            <span class="comment">//check for collision with the screen boundries</span>
            <span class="keywordflow">if</span>(sprites[i].x &lt; (1&lt;&lt;8) || sprites[i].x &gt; (247 &lt;&lt; 8))
                sprites[i].dx = -sprites[i].dx;

            <span class="keywordflow">if</span>(sprites[i].y &lt; (1&lt;&lt;8) || sprites[i].y &gt; (182 &lt;&lt; 8))
                sprites[i].dy = -sprites[i].dy;
            
            <span class="comment">//reposition the sprites</span>
            MoveSprite(&amp;sprites[i]);
        }
        

    
        <span class="comment">//do the plasma/fire</span>
        <span class="keywordflow">for</span>(ix = 0; ix &lt; <a name="a34"></a><a class="code" href="a00135.html#a2cd109632a6dcccaa80b43561b1ab700" title="Screen width in pixels.">SCREEN_WIDTH</a>; ix++) {
            back[ix + SCREEN_WIDTH * (<a name="a35"></a><a class="code" href="a00135.html#a6974d08a74da681b3957b2fead2608b8" title="Screen height in pixels.">SCREEN_HEIGHT</a> - 1)] = rand()&amp; 0xFFFF;
            back[ix + SCREEN_WIDTH * (<a class="code" href="a00135.html#a6974d08a74da681b3957b2fead2608b8" title="Screen height in pixels.">SCREEN_HEIGHT</a> - 2)] = rand()&amp; 0xFFFF;
        }

        back++;
        
        <span class="keywordflow">for</span>(iy = 1; iy &lt; <a class="code" href="a00135.html#a6974d08a74da681b3957b2fead2608b8" title="Screen height in pixels.">SCREEN_HEIGHT</a> - 2 ; iy++) {
            <span class="keywordflow">for</span>(ix = 1; ix &lt; SCREEN_WIDTH - 1; ix++)  {
                red = 0;

                red += front[0];
                red += front[2];
    
                front += SCREEN_WIDTH;

                red += front[0];
                red += front[1];
                red += front[2];
                
                front += SCREEN_WIDTH;

                red += front[0];
                red += front[1];
                red += front[2];

                front -= (2 * SCREEN_WIDTH) - 1;    

                back[0] =  (red &gt;&gt; 3);  
                back++;
            }
            back += 2;
            front += 2;
        
        }

        <a name="a36"></a><a class="code" href="a00111.html#a1e8361fc4819e3f39d187dc5c29c279a" title="Wait for vblank interrupt.">swiWaitForVBlank</a>();
        
        updateOAM();

        <span class="comment">//flip screens</span>
        <span class="keywordflow">if</span>(screen) {
            <a class="code" href="a00135.html#ae3ea5c2e57cc40d6a88e21c4dcb742c8" title="the main 2D engine video mode">videoSetMode</a>(<a class="code" href="a00135.html#a1e46218ee302fcc8c77e4ea0968ea149a31546318607e0b541f01adc27eb2e138" title="video display directly from VRAM_B in LCD mode">MODE_FB1</a>);
            front = <a class="code" href="a00135.html#a00d7e905c9e3c3c29fd2eee42c6b8d86" title="pointer to vram bank B mapped as LCD">VRAM_B</a>;
            back = <a class="code" href="a00135.html#a0871eee8d0d2336c97e93d3d5a97e415" title="pointer to vram bank A mapped as LCD">VRAM_A</a>;
            screen = 0;
        } <span class="keywordflow">else</span> {
            <a class="code" href="a00135.html#ae3ea5c2e57cc40d6a88e21c4dcb742c8" title="the main 2D engine video mode">videoSetMode</a>(<a name="a37"></a><a class="code" href="a00135.html#a1e46218ee302fcc8c77e4ea0968ea149a7579b9dbdcd3be83565c4cbd29bd67e9" title="video display directly from VRAM_A in LCD mode">MODE_FB0</a>); 
            front = <a class="code" href="a00135.html#a0871eee8d0d2336c97e93d3d5a97e415" title="pointer to vram bank A mapped as LCD">VRAM_A</a>;
            back = <a class="code" href="a00135.html#a00d7e905c9e3c3c29fd2eee42c6b8d86" title="pointer to vram bank B mapped as LCD">VRAM_B</a>;
            screen = 1;
        }
    }    
    <span class="keywordflow">return</span> 0;
}

</pre></div> </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated on Mon Jul 26 10:36:03 2010 for libnds by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
