<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>libnds: capture/ScreenShot/source/screenshot.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="docs.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>capture/ScreenShot/source/screenshot.cpp</h1><div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;<a class="code" href="a00119.html" title="the master include file for nds applications.">nds.h</a>&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>

<span class="preprocessor">#include &lt;fat.h&gt;</span>

<span class="preprocessor">#include &quot;screenshot.h&quot;</span>
<span class="preprocessor">#include &quot;bmp.h&quot;</span>

<span class="keywordtype">void</span> wait();

<span class="keywordtype">void</span> screenshot(<a name="a0"></a><a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>* buffer) {

    <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a> vram_cr_temp=VRAM_A_CR;
    VRAM_A_CR=<a name="a1"></a><a class="code" href="a00135.html#a348d2824280b1b94792407f4920e346aa48ee60158f850200439ff2261233d6ad" title="maps vram a to lcd.">VRAM_A_LCD</a>;

    <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>* vram_temp=(<a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>*)malloc(128*1024);
    <a name="a2"></a><a class="code" href="a00101.html#ac77a16a7cb9f2fa2b4361c22fe84245d" title="copies from source to destination using channel 3 of DMA available channels in half...">dmaCopy</a>(<a name="a3"></a><a class="code" href="a00135.html#a0871eee8d0d2336c97e93d3d5a97e415" title="pointer to vram bank A mapped as LCD">VRAM_A</a>, vram_temp, 128*1024);

    REG_DISPCAPCNT=DCAP_BANK(0)|DCAP_ENABLE|DCAP_SIZE(3);
    <span class="keywordflow">while</span>(REG_DISPCAPCNT &amp; DCAP_ENABLE);

    <a class="code" href="a00101.html#ac77a16a7cb9f2fa2b4361c22fe84245d" title="copies from source to destination using channel 3 of DMA available channels in half...">dmaCopy</a>(<a class="code" href="a00135.html#a0871eee8d0d2336c97e93d3d5a97e415" title="pointer to vram bank A mapped as LCD">VRAM_A</a>, buffer, 256*192*2);
    <a class="code" href="a00101.html#ac77a16a7cb9f2fa2b4361c22fe84245d" title="copies from source to destination using channel 3 of DMA available channels in half...">dmaCopy</a>(vram_temp, <a class="code" href="a00135.html#a0871eee8d0d2336c97e93d3d5a97e415" title="pointer to vram bank A mapped as LCD">VRAM_A</a>, 128*1024);
    
    VRAM_A_CR=vram_cr_temp;
    
    free(vram_temp);

}

<span class="keywordtype">void</span> screenshot(<span class="keywordtype">char</span>* filename) {

    fatInitDefault();
    FILE* file=fopen(filename, <span class="stringliteral">&quot;w&quot;</span>);

    <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>* temp=(<a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>*)malloc(256*192*2);
    <a class="code" href="a00101.html#ac77a16a7cb9f2fa2b4361c22fe84245d" title="copies from source to destination using channel 3 of DMA available channels in half...">dmaCopy</a>(<a name="a4"></a><a class="code" href="a00135.html#a00d7e905c9e3c3c29fd2eee42c6b8d86" title="pointer to vram bank B mapped as LCD">VRAM_B</a>, temp, 256*192*2);
    fwrite(temp, 1, 256*192*2, file);
    fclose(file);
    free(temp);
}

<span class="keywordtype">void</span> write16(<a name="a5"></a><a class="code" href="a00121.html#ace9d960e74685e2cd84b36132dbbf8aa" title="16 bit unsigned integer.">u16</a>* address, <a class="code" href="a00121.html#ace9d960e74685e2cd84b36132dbbf8aa" title="16 bit unsigned integer.">u16</a> value) {

    <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>* first=(<a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>*)address;
    <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>* second=first+1;

    *first=value&amp;0xff;
    *second=value&gt;&gt;8;
}

<span class="keywordtype">void</span> write32(<a name="a6"></a><a class="code" href="a00121.html#afaa62991928fb9fb18ff0db62a040aba" title="32 bit unsigned integer.">u32</a>* address, <a class="code" href="a00121.html#afaa62991928fb9fb18ff0db62a040aba" title="32 bit unsigned integer.">u32</a> value) {

    <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>* first=(<a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>*)address;
    <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>* second=first+1;
    <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>* third=first+2;
    <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>* fourth=first+3;

    *first=value&amp;0xff;
    *second=(value&gt;&gt;8)&amp;0xff;
    *third=(value&gt;&gt;16)&amp;0xff;
    *fourth=(value&gt;&gt;24)&amp;0xff;
}

<span class="keywordtype">void</span> screenshotbmp(<span class="keyword">const</span> <span class="keywordtype">char</span>* filename) {

    fatInitDefault();
    FILE* file=fopen(filename, <span class="stringliteral">&quot;wb&quot;</span>);

    REG_DISPCAPCNT=DCAP_BANK(3)|DCAP_ENABLE|DCAP_SIZE(3);
    <span class="keywordflow">while</span>(REG_DISPCAPCNT &amp; DCAP_ENABLE);

    <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>* temp=(<a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a>*)malloc(256*192*3+<span class="keyword">sizeof</span>(INFOHEADER)+<span class="keyword">sizeof</span>(HEADER));

    HEADER* header=(HEADER*)temp;
    INFOHEADER* infoheader=(INFOHEADER*)(temp+<span class="keyword">sizeof</span>(HEADER));

    write16(&amp;header-&gt;type, 0x4D42);
    write32(&amp;header-&gt;size, 256*192*3+<span class="keyword">sizeof</span>(INFOHEADER)+<span class="keyword">sizeof</span>(HEADER));
    write32(&amp;header-&gt;offset, <span class="keyword">sizeof</span>(INFOHEADER)+<span class="keyword">sizeof</span>(HEADER));
    write16(&amp;header-&gt;reserved1, 0);
    write16(&amp;header-&gt;reserved2, 0);

    write16(&amp;infoheader-&gt;bits, 24);
    write32(&amp;infoheader-&gt;size, <span class="keyword">sizeof</span>(INFOHEADER));
    write32(&amp;infoheader-&gt;compression, 0);
    write32(&amp;infoheader-&gt;width, 256);
    write32(&amp;infoheader-&gt;height, 192);
    write16(&amp;infoheader-&gt;planes, 1);
    write32(&amp;infoheader-&gt;imagesize, 256*192*3);
    write32(&amp;infoheader-&gt;xresolution, 0);
    write32(&amp;infoheader-&gt;yresolution, 0);
    write32(&amp;infoheader-&gt;importantcolours, 0);
    write32(&amp;infoheader-&gt;ncolours, 0);

    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> y=0;y&lt;192;y++)
    {
        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> x=0;x&lt;256;x++)
        {
            <a class="code" href="a00121.html#ace9d960e74685e2cd84b36132dbbf8aa" title="16 bit unsigned integer.">u16</a> color=<a name="a7"></a><a class="code" href="a00135.html#a6fd22203058e16dc7b1ca343d774296b" title="pointer to vram bank D mapped as LCD">VRAM_D</a>[256*192-y*256+x];

            <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a> b=(color&amp;31)&lt;&lt;3;
            <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a> g=((color&gt;&gt;5)&amp;31)&lt;&lt;3;
            <a class="code" href="a00121.html#a92c50087ca0e64fa93fc59402c55f8ca" title="8 bit unsigned integer.">u8</a> r=((color&gt;&gt;10)&amp;31)&lt;&lt;3;

            temp[((y*256)+x)*3+<span class="keyword">sizeof</span>(INFOHEADER)+<span class="keyword">sizeof</span>(HEADER)]=r;
            temp[((y*256)+x)*3+1+<span class="keyword">sizeof</span>(INFOHEADER)+<span class="keyword">sizeof</span>(HEADER)]=g;
            temp[((y*256)+x)*3+2+<span class="keyword">sizeof</span>(INFOHEADER)+<span class="keyword">sizeof</span>(HEADER)]=b;
        }
    }

    <a name="a8"></a><a class="code" href="a00093.html#aa5b7f47a8a914faa793ffa33619f6373" title="flush the entire data cache to memory.">DC_FlushAll</a>();
    fwrite(temp, 1, 256*192*3+<span class="keyword">sizeof</span>(INFOHEADER)+<span class="keyword">sizeof</span>(HEADER), file);
    fclose(file);
    free(temp);
}
</pre></div> </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated on Mon Jul 26 10:36:03 2010 for libnds by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
