<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>libnds: audio/maxmod/streaming/source/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="docs.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>audio/maxmod/streaming/source/main.c</h1><div class="fragment"><pre class="fragment"><span class="comment">/****************************************************************</span>
<span class="comment"> * this example demonstrates streaming synthensized audio</span>
<span class="comment"> ****************************************************************/</span>
 
<span class="preprocessor">#include &lt;<a class="code" href="a00119.html" title="the master include file for nds applications.">nds.h</a>&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;maxmod9.h&gt;</span>

<span class="keywordtype">int</span> sine;       <span class="comment">// sine position</span>
<span class="keywordtype">int</span> lfo;        <span class="comment">// LFO position</span>

<span class="comment">//-----------------------------------------------------------------------------</span>
<span class="keyword">enum</span> {
<span class="comment">//-----------------------------------------------------------------------------</span>
    <span class="comment">// waveform base frequency</span>
    sine_freq = 500,
    
    <span class="comment">// LFO frequency</span>
    lfo_freq = 3,
    
    <span class="comment">// LFO output shift amount</span>
    lfo_shift = 4,
    
    <span class="comment">// blue backdrop</span>
    bg_colour = 13 &lt;&lt; 10,
    
    <span class="comment">// red cpu usage</span>
    cpu_colour = 31
};

<span class="comment">/***********************************************************************************</span>
<span class="comment"> * on_stream_request</span>
<span class="comment"> *</span>
<span class="comment"> * Audio stream data request handler.</span>
<span class="comment"> ***********************************************************************************/</span>
mm_word on_stream_request( mm_word length, mm_addr dest, mm_stream_formats format ) {
<span class="comment">//----------------------------------------------------------------------------------</span>
    
    <a name="a0"></a><a class="code" href="a00121.html#aa980e2c02ba2305e0f489d5650655425" title="16 bit signed integer.">s16</a> *target = dest;
    
    <span class="comment">//------------------------------------------------------------</span>
    <span class="comment">// synthensize a sine wave with an LFO applied to the pitch</span>
    <span class="comment">// the stereo data is interleaved</span>
    <span class="comment">//------------------------------------------------------------</span>
    <span class="keywordtype">int</span> len = length;
    <span class="keywordflow">for</span>( ; len; len-- )
    {
        <span class="keywordtype">int</span> sample = <a name="a1"></a><a class="code" href="a00134.html#a4488c5e9ab13094d971be867ea431846" title="fixed point sine">sinLerp</a>(sine);
        
        <span class="comment">// output sample for left</span>
        *target++ = sample;
        
        <span class="comment">// output inverted sample for right</span>
        *target++ = -sample;
        
        sine += sine_freq + (<a class="code" href="a00134.html#a4488c5e9ab13094d971be867ea431846" title="fixed point sine">sinLerp</a>(lfo) &gt;&gt; lfo_shift);
        lfo = (lfo + lfo_freq);
    }
    
    <span class="keywordflow">return</span> length;
}

<span class="comment">/**********************************************************************************</span>
<span class="comment"> * main</span>
<span class="comment"> *</span>
<span class="comment"> * Program Entry Point</span>
<span class="comment"> **********************************************************************************/</span>
<span class="keywordtype">int</span> main( <span class="keywordtype">void</span> ) {
<span class="comment">//---------------------------------------------------------------------------------</span>

    <span class="comment">//----------------------------------------------------------------</span>
    <span class="comment">// print out some stuff</span>
    <span class="comment">//----------------------------------------------------------------</span>
    <a name="a2"></a><a class="code" href="a00096.html#a2fb290779a23a2ccf4da6097d83d8323" title="Initialize the console to a default state for prototyping. This function sets the...">consoleDemoInit</a>();
    iprintf( <span class="stringliteral">&quot;\n    Maxmod Streaming Example   \n&quot;</span>);

    <span class="comment">//----------------------------------------------------------------</span>
    <span class="comment">// initialize maxmod without any soundbank (unusual setup)</span>
    <span class="comment">//----------------------------------------------------------------</span>
    mm_ds_system sys;
    sys.mod_count           = 0;
    sys.samp_count          = 0;
    sys.mem_bank            = 0;
    sys.fifo_channel        = <a name="a3"></a><a class="code" href="a00104.html#a4965d26f6beda1fa71dfb45ac9388e3cac6bcb498a4ee9f0477bafac990a29d90" title="fifo channel reserved for the maxmod library.">FIFO_MAXMOD</a>;
    mmInit( &amp;sys );
    
    <span class="comment">//----------------------------------------------------------------</span>
    <span class="comment">// open stream</span>
    <span class="comment">//----------------------------------------------------------------</span>
    mm_stream mystream;
    mystream.sampling_rate  = 25000;                    <span class="comment">// sampling rate = 25khz</span>
    mystream.buffer_length  = 1200;                     <span class="comment">// buffer length = 1200 samples</span>
    mystream.callback       = on_stream_request;        <span class="comment">// set callback function</span>
    mystream.format         = MM_STREAM_16BIT_STEREO;   <span class="comment">// format = stereo 16-bit</span>
    mystream.timer          = MM_TIMER0;                <span class="comment">// use hardware timer 0</span>
    mystream.manual         = <span class="keyword">true</span>;                     <span class="comment">// use manual filling</span>
    mmStreamOpen( &amp;mystream );
        
    <span class="comment">//----------------------------------------------------------------</span>
    <span class="comment">// when using &#39;automatic&#39; filling, your callback will be triggered</span>
    <span class="comment">// every time half of the wave buffer is processed.</span>
    <span class="comment">//</span>
    <span class="comment">// so: </span>
    <span class="comment">// 25000 (rate)</span>
    <span class="comment">// ----- = ~21 Hz for a full pass, and ~42hz for half pass</span>
    <span class="comment">// 1200  (length)</span>
    <span class="comment">//----------------------------------------------------------------</span>
    <span class="comment">// with &#39;manual&#39; filling, you must call mmStreamUpdate</span>
    <span class="comment">// periodically (and often enough to avoid buffer underruns)</span>
    <span class="comment">//----------------------------------------------------------------</span>
    
    <a name="a4"></a><a class="code" href="a00130.html#aa95f7cc84de885b035512a5a6ee007c6" title="sets the Y trigger(?)">SetYtrigger</a>( 0 );
    <a name="a5"></a><a class="code" href="a00111.html#a5906b6a5b438e991f62d909c26efb720" title="Allow the given interrupt to occur.">irqEnable</a>( <a name="a6"></a><a class="code" href="a00111.html#ae384b89225fb3517bba35d3dc790c716ae966b54fa824aa30270c82ef8bfd219d">IRQ_VCOUNT</a> );
    
    <span class="keywordflow">while</span>( 1 )
    {
        <span class="comment">// wait until line 0</span>
        <a name="a7"></a><a class="code" href="a00111.html#ad45a05d9be5ec91316286726bdee338a" title="wait for interrupt(s) to occur">swiIntrWait</a>( 0, <a class="code" href="a00111.html#ae384b89225fb3517bba35d3dc790c716ae966b54fa824aa30270c82ef8bfd219d">IRQ_VCOUNT</a>);
        
        <span class="comment">// update stream</span>
        mmStreamUpdate();
        
        <span class="comment">// restore backdrop (some lines were drawn with another colour to show cpu usage)</span>
        <a name="a8"></a><a class="code" href="a00135.html#a5f83d4f33ba2cd0fe614788505151262" title="background palette memory (sub engine)">BG_PALETTE_SUB</a>[0] = bg_colour;
        
        <span class="comment">// wait until next frame</span>
        <a name="a9"></a><a class="code" href="a00111.html#a1e8361fc4819e3f39d187dc5c29c279a" title="Wait for vblank interrupt.">swiWaitForVBlank</a>();
        
        <span class="comment">// set backdrop to show cpu usage</span>
        <a class="code" href="a00135.html#a5f83d4f33ba2cd0fe614788505151262" title="background palette memory (sub engine)">BG_PALETTE_SUB</a>[0] = cpu_colour;
    }
    
    <span class="keywordflow">return</span> 0;
}
</pre></div> </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated on Mon Jul 26 10:36:03 2010 for libnds by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
